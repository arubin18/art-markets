---
title: "main"
output: html_document
---

## load libaries  

```{r setup, include=FALSE}

library(magrittr)
library(dplyr)
library(feather)
library(stringr)

```

## import data from file and save to feather

```{r setup, include=FALSE}

MyData <- read.csv(file="~/Art-Markets/Analysis/whole_data.csv", header=TRUE, sep=",")

path <- "dataset.feather"

write_feather(MyData, path)

```

## clean data

```{r setup, include=FALSE}

path <- "dataset.feather"

MyData <- read_feather(path)

# change data types
MyData$year_created = strtoi(MyData$year_created)
MyData$sold = strtoi(MyData$sold)
MyData

# create categorical variable representing lot position
MyData %<>%
  select(-img_url) %>%
  mutate(lot_position = case_when(
    .$auction_lot > 0 & .$auction_lot <= 0.25 ~ 1,
    .$auction_lot > 0.25 & .$auction_lot <= 0.5 ~ 2,
    .$auction_lot > 0.5 & .$auction_lot <= 0.75 ~ 3,
    .$auction_lot > 0.75 & .$auction_lot <= 1.00 ~ 4
    ))

MyData$lot_position <- as.factor(MyData$lot_position)

# merge the phillips auctions
MyData$auction_house[MyData$auction_house == "Phillips de Pury & Co. (see Phillips)"] <- paste("Phillips", MyData$city[MyData$auction_house == "Phillips de Pury & Co. (see Phillips)"], sep=" ")

## create categorical variable for auction house caliber
# get auction house rankings
house_rankings <- MyData %>%
  group_by(city, auction_house) %>%
  summarise(n = n()) %>%
  arrange(desc(n)) %>%
  mutate(ranking = row_number()) %>%
  select(-n)

# get auction house rankings for each observation
MyData <- merge(MyData, house_rankings, by = c("auction_house", "city"))

# assign caliber 
MyData %<>% 
  mutate(caliber = case_when(
    .$ranking <= 2 ~ "Major",
    .$ranking > 2 & .$ranking <= 5 ~ "Medium",
    .$ranking > 5 ~ "Small")) %>%
  select(-ranking)

# create dummy for has volume 
# filter for year, artists with volume of works greater than or equal to 10, artwork is signed

MyData %<>%
  mutate(dummy_volume = ifelse(volume > 0, 1, 0)) %>%
  filter(year_created >= 1950 & year_created < 1980) %>%
  filter(artist_volume >= 10) %>%
  filter(signed >= 1) %>%
  select(-signed)

MyData$dummy_volume <- as.factor(MyData$dummy_volume)

## create categories for medium
# convert mediums to lowercase
MyData$medium <- tolower(MyData$medium)

MyData %<>%
  filter(dummy_volume == 0) %>%
  select(-c(volume, dummy_volume))

is_mixed_media <- function(medium){
  return (str_detect(medium, "&") | str_detect(medium, "and") | str_detect(medium, "with") 
          | str_detect(medium, "mixed media"))
}

is_panting <- function(medium){
  return (str_detect(medium, "oil") | str_detect(medium, "tempera") | str_detect(medium, "acrylic")
           | str_detect(medium, "ink") | str_detect(medium, "pastel"))
}

is_works_on_paper <- function(medium){
  return (str_detect(medium, "watercolor") | str_detect(medium, "gouache") | str_detect(medium, "pencil")
          | str_detect(medium, "crayon") | str_detect(medium, "pen"))
}

MyData %<>%
  filter(is_mixed_media(medium) | is_panting(medium) | is_works_on_paper(medium)) %>%
  mutate(medium_type = case_when(
    is_mixed_media(.$medium) ~ "Mixed Media",
    is_panting(.$medium) & !is_mixed_media(.$medium) ~ "Painting",
    is_works_on_paper(.$medium) & !is_mixed_media(.$medium) ~ "Works on Paper"))

## filter for non western art 

MyData$exhibition <- tolower(MyData$exhibition)

is_western <- function(exhibition){
  return (!(str_detect(exhibition, "asian") | str_detect(exhibition, "middle eastern") | str_detect(exhibition, "turkish")
            | str_detect(exhibition, "indian") | str_detect(exhibition, "african") | str_detect(exhibition, "latin american")))
}

MyData %<>%
  mutate(dummy_western = ifelse(is_western(exhibition), 1, 0))

# filter for western art
MyData %<>%
  filter(dummy_western == 1) %>%
  select(-dummy_western)

## filter for largest medium type of western art
types <- MyData %>%
  group_by(medium_type) %>%
  summarise(n = n()) %>%
  top_n(1)

top_type = types[[1]]

MyData %<>%
  filter(medium_type == top_type) %>%
  select(-medium_type)

# get rankings of artists with respect to frequency
artists <- MyData %>%
  group_by(artist) %>%
  summarise(n = n()) %>%
  arrange(desc(n))

# get rid of extreme values or corrupted values
# - artworks with no average estimate (not many observations) 
MyData %<>%
  filter(avg_estimate != 0) %>%
  filter(area < 100000)

```

## get data for artworks that have sold

```{r setup, include=FALSE}

MyDataSold <- MyData %>%
  filter(sold == 1) %>%
  select(-sold)

```

## export cleaned data

```{r setup, include=FALSE}

write.csv(MyData, file="cleaned_data.csv")


```


